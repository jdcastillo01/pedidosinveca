<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CRM PRO</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo"><i class="fab fa-whatsapp"></i> PEDIDOS ISELITAS</div>
            <nav>
                <form action="/importar" method="post" enctype="multipart/form-data" id="importForm">
                    <label for="file-upload" class="custom-file-upload">
                        <i class="fas fa-cloud-upload-alt"></i> Cargar Cartera
                    </label>
                    <input id="file-upload" type="file" name="file" onchange="this.form.submit()"/>
                </form>
                <a href="/limpiar" class="btn-clear" onclick="return confirm('¿Borrar todo?')">Vaciar Lista</a>
            </nav>
        </aside>

        <main class="content">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Teléfono</th>
                            <th>Estado</th>
                            <th style="text-align:right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-clientes">
                        {% for cliente in clientes %}
                        <tr id="fila-{{ cliente.id }}">
                            <td class="client-name">{{ cliente.nombre }}</td>
                            <td class="client-tel">+{{ cliente.telefono }}</td>
                            <td>
                                <span class="status-pill {{ 'status-vendido' if cliente.estatus == 'Vendido' else 'status-espera' }}">
                                    {{ cliente.estatus }}
                                </span>
                            </td>
                            <td class="actions">
                                <button onclick="cambiarEstatus(this, {{ cliente.id }})" class="btn-icon">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <a href="https://wa.me/{{ cliente.telefono }}?text={{ ('Hola, quisiera solicitar el pedido para ' + cliente.nombre)|urlencode }}" target="_blank" class="btn-wa">
                                    <i class="fab fa-whatsapp"></i> Chat
                                </a>
                                <button onclick="eliminarCliente({{ cliente.id }})" class="btn-icon del">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        function cambiarEstatus(boton, id) {
            fetch(`/cambiar_estatus/${id}`)
            .then(res => res.json())
            .then(data => {
                const fila = document.getElementById(`fila-${id}`);
                const badge = fila.querySelector('.status-pill');
                badge.textContent = data.nuevo_estatus;
                badge.className = data.nuevo_estatus === 'Vendido' ? 'status-pill status-vendido' : 'status-pill status-espera';
            });
        }

        function eliminarCliente(id) {
            if(!confirm('¿Eliminar cliente?')) return;
            fetch(`/eliminar/${id}`, { method: 'DELETE' })
            .then(() => {
                const fila = document.getElementById(`fila-${id}`);
                fila.style.opacity = '0';
                setTimeout(() => fila.remove(), 300);
            });
        }
    </script>
</body>
</html>